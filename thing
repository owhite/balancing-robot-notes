#ifdef POSVEL_PLANE
#endif

// ===== Bare-metal GPIO toggle on STM32F405 (PB3, no HAL) =====
#include "stm32f4xx.h"   // CMSIS only

#define JIT_PORT      GPIOB
#define JIT_PIN_N     3U
#define JIT_PIN_MASK  (1U << JIT_PIN_N)

#ifdef POSVEL_PLANE
static inline void jitter_pin_init(void) {
  // If trace is on, PB3 may be claimed as JTDO/TRACESWO; turn it off.
  // (TRACE_IOEN is 0 by default, but this is safe.)
  DBGMCU->CR &= ~DBGMCU_CR_TRACE_IOEN;

  // 1) Enable GPIOB clock
  RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;
  (void)RCC->AHB1ENR;               // ensure write completes

  // 2) MODER: PB3 = 01 (general-purpose output)
  JIT_PORT->MODER &= ~(3U << (JIT_PIN_N * 2));
  JIT_PORT->MODER |=  (1U << (JIT_PIN_N * 2));

  // 3) OTYPER: push-pull
  JIT_PORT->OTYPER &= ~JIT_PIN_MASK;

  // 4) OSPEEDR: very high speed (11)
  JIT_PORT->OSPEEDR |=  (3U << (JIT_PIN_N * 2));

  // 5) PUPDR: no pull
  JIT_PORT->PUPDR &= ~(3U << (JIT_PIN_N * 2));

  // Optional: start low
  JIT_PORT->BSRR = (JIT_PIN_MASK << 16);   // reset bit
}
#endif

// Ultra-fast set/clear/toggle helpers
static inline void jit_set(void)    { JIT_PORT->BSRR =  JIT_PIN_MASK; }
static inline void jit_clr(void)    { JIT_PORT->BSRR = (JIT_PIN_MASK << 16); }
static inline void jit_toggle(void) { JIT_PORT->ODR  ^= JIT_PIN_MASK; }

// Example use
void FOC_Loop(void) {
  jit_set();     // or jit_toggle() for a square wave
  // ... your FOC math ...
  jit_clr();     // for pulse-width = loop time
}
